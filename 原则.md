### 原则

#### mesh协议层

- 单点通讯保达，错误状态不可知
- 多点通讯原则上保达，通过参数设置可靠性和延迟



#### mesh和接口

- 保达，错误状态不可知
- 通过上报数据来判断结果
- ota异步，独立检查，进行ota时，所有通信不可用



#### 全自动配网要点

- 初始时，以相同meshid组网
- 中间层判断组网承载量，判断是否需要生成新mesh并，更换mesh
- 探测现有mesh承载量
- meshid 不可重复存在



#### 中间层资源保护操作

##### mesh结构变化

- ip变化
- 设备数量变化
- mesh个数变化

##### 向mesh写数据



### ota相关

- 发起者：持久层延迟/立即
- 特殊状态置位：持久层，
- 特殊状态状态结束置位：设备



### 数据传递

- mesh：base_shell
- mesh&interface：interface_shell（包含mesh_id）



### 模式

#### 突发模式

- json
- mac
- version

#### 汇集模式

- 拓扑结构
- 字节化数据
- 详细
  - 由最底层节点发出启动数据包
  - 最大6层
  - 每层超时时间固定
  - 最低超时时间总为0

 

| layer | delay（s） |
| ----- | :--------- |
| 1     |            |
| 2     | 15         |
| 3     | 10         |
| 4     | 7          |
| 5     | 4          |
| 6     | 0          |

### 状态

汇集模式重置所有特殊状态

#### 特殊状态

##### 群体OTA

##### 应对操作

- 中间层：停止发起数据汇集
- root：无
- 子节点：无



### 判断

- 接口层判断mesh是否空闲依据：
  - 持久层置位，设备汇集复位（空闲）
- 含有设备判断：
  - 突发数据
- 设备版本判断：
  - 突发数据
- 设备离线判断
  - 下发
    - 下发失败报告
  - 上报
    - 汇集数据不存在



### 杂项

- 设备拓扑结构：汇集
- 拥有初始meshid的设备不会汇集上报，只会一直发送mesh设备数量信息，发送的ip发现不会被记录